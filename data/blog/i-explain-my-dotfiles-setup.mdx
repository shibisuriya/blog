---
title: 'I explain my dotfiles setup'
date: '2024-06-03'
lastmod: '2024-06-03'
tags:
  [
    'dotfiles',
    'distro-hopping',
    'developer-productivity',
    'ricing',
    'docker',
    'unix',
    'linux',
    'gnu-stow',
    'neovim',
    'ansible-playbook',
    'lab',
    'devops',
  ]
draft: false
summary:
  'I explain how I manage my dotfiles using neat tools like nix package manager,
  Docker, Ansible playbook, etc.'
images: ['/static/images/blogs/i-explain-my-dotfiles-setup/tux-propose.svg']
layout: PostLayout
---

I will be explaining my dotfiles setup in this blog post, if you are someone who
doesn't know what dotfiles are, why would you want to manage them, etc. read my
simple tutorial on ['how to manage dotfiles'](/blog/how-to-manage-dotfiles).

I own two computers, a PC that has Ubuntu and Windows 11 installed (dual boot)
and a M1 Macbook pro that I use for office work. I am a software engineer by
profession, my work mostly revolves around backend systems, databases,
infrastructure, virtual machine, Docker containers, etc. I prefer Ubuntu or
macOS for software development & only boot into windows for play computer games,
I haven't ported my dotfiles to windows for this reason. My dotfiles work fine
in Ubuntu & macOS.

This blog post also serves as a README for my publically maintained
[dotfiles repo](https://github.com/shibisuriya/.dotfiles), this is intentional
because it forces me to keep this blog post neat & updated so that I can
reference it while setting up a new computer.

# macOS

1. I install [nix (the package manager) for macOS](https://nixos.org/download/),
   I do a multi user installation.

2. I clone my dotfiles repo,

```bash
nix-shell -p git --run "git clone --recurse-submodules https://github.com/shibisuriya/.dotfiles ~/.dotfiles"
```

3. I Install nix-darwin

```bash
nix run nix-darwin --extra-experimental-features 'nix-command flakes' -- switch --flake ~/.dotfiles/nix-darwin#shibi
```

Note: `nix-darwin` in the above command refers to a flake input.

Ones run, I will have access to the `darwin-rebuild` command.

```bash
darwin-rebuild switch --flake ~/.dotfiles/nix-darwin#shibi
```

4. Install 'Apple Command Line Tools (CLT)'

Neovim Mason uses Apple CLT to build some language servers that I use from
source code.

```bash
xcode-select install
```

CLT is a subset of Xcode, the command above will not install complete Xcode.

Note: This step can't be automated using nix and must be performed manually.

5. Install TPM - Tmux Package Manager,

```bash
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
```

Note: This step can be automated using nix but I haven't automated it yet.

6. Symlink the dotfiles to their target locations using GNU Stow,

```bash
cd ~/.dotfiles
./stow.zsh # A shell script, uses GNU Stow under the hood.
```

7. Update the `.gitconfig` file (this step needs to be automated, I am
   performing this step manually for now because I don't want to store my email,
   full name, etc. in the .gitconfig file publically).

8. I manually install non-free software like Chrome, Obsidian, Docker desktop,
   etc. I maintain a list of non-free software that I need in this blog post so
   that I can refer it while setting up a new computer.

## Formatting .nix files

Code formatters to format .nix files such as 'alejandra', 'nixfmt', etc. for
Neovim are not supported in Apple Silicon, use the `nix fmt` command instead,

```bash
cd ~/.dotfiles/nix-darwin
nix fmt
```

# Testing my setups

For testing/iterating purposes I don't install my dotfiles on my host computer.
The obivious reason for this is, I already have my dotfiles installed on my
host, I don't want to reinstall it - I want a computer with 'fresh install'!
Also I don't want to put my host into an incomplete state with partially
installed applications, unnecessary files & directories created, etc. (if the
installation process fails for some reason, happens often while making changes
to the dotfiles), obiviously nix allows me to prevent this, nix builds are
"atomic" either they succeeds completely or nothing changes but I prefer to test
my dotfiles files in an isolated environment, either on a computer having a
'fresh install' or in virtual environments.

### For macOS (using UTM)

1. Download and install [UTM](https://mac.getutm.app/), a simple and intuitive
   app for creating and managing virtual machines on macOS; it is a wrapper
   around [QEMU](https://www.qemu.org/).

1. Create a macOS VM in UTM.
   ![Create macOS vm in UTM](/static/images/managing-dotfiles/utm-1.png)

1. Create a clone of the VM. Use the clone for testing/iterating... If something
   goes wrong, you can delete the clone and create another one.
   ![Clone vm in UTM](/static/images/managing-dotfiles/utm-2.png)

1. Follow these [steps](#macos).

You can iterate and test your dotfiles without worry about leaving your host in
an undesirable state if something fails or breaks.

### Ubuntu / Docker image

I build a Ubuntu based docker image to verify if my dotfiles install flawlessly,
if the docker build fails for some reason then my dotfiles have issues, I can
immediately correct them and rebuild without worrying about my host computer
getting put into incomplete states. This allows me to test and iterate faster, I
don't want a computer with 'fresh install' which take some time to provision!

You can build a Ubuntu based docker image which has most of the programs you
need preinstalled and configured using your dotfiles.

To build the docker image,

```bash
docker build --target prod -t dotfiles .
```

You can then create a container using this image and copy or volume mount
directories/files from your host. This is extremely useful for
tinkering/testing/learning new things without worrying about random programs
modifying your host’s settings.

```bash
docker run -it --rm -v .:/root/directory_1 dotfiles
```

Currently I am using ansible playbook to install and configure the programs that
I need in the Docker container... I am planning to replace ansible with nix...
In any cases, you might want to debug/change the build process...

To create a Ubuntu based docker image that has Ansible and Nix preinstalled,

```bash
docker build --target dev -t dotfiles:dev .
```

Spin up a container based on this image and volume mount/copy your dotfiles into
it.

```bash
docker run -it --rm -v .:/root/.dotfiles dotfiles:dev
```

Run the ansible playbook,

```bash
ansible-playbook /root/.dotfiles/local.yml
```

# Non-free software I need

- Chrome
- Obsidian
- Docker desktop

# Eternal learner/explorer

The way I manage my dotfiles currently might not be perfect... I am aware that
the tools and techniques that I currently use are not the absolute best, and
there are better alternatives. My current setup works for me, even if it is
imperfect. I am an eternal learner, I will try hard to keep this blog post
updated or rewrite it if required as I explore and adopt new tools and
techniques since this blog post also serves as a README for my publically
maintained [dotfiles](https://github.com/shibisuriya/.dotfiles) repository and
as a personal reference. Feel free to
[share suggestions](https://github.com/shibisuriya/.dotfiles/issues), or let
[me](https://linkedin.com/in/shibisuriya) know if you’d want me to try
something. Thanks for reading my blog post.
